#==========================================
# LLM Passthrough Service Alerting Rules
# Dashboard: LLM Passthrough Service - Unified Observability
# Dashboard UID: llm-passthrough-unified-observability
#==========================================

#==========================================
# Reusable YAML Anchors
#==========================================

# Reusable label definitions
x-default-labels: &x-default-labels
  team: "llm_passthrough_platform"
  pillar: "flex"
  value_stream: "ai"
  sub_stream: "ai_foundational_experiences"
  service: "service-large-language-model"
  contact_point: "llm_passthrough_prod_pagerduty"

x-default-rule-settings-ukg-pro: &x-default-rule-settings-ukg-pro
  data_source: UKG Pro
  alert_group: FleX - AI - LLM Passthrough
  interval: 5m


grafanacloud_rules:

  # CRITICAL ALERT: High Error Rate (5xx)
  # Per technical requirements: 5xx error rate > 15% for 15 minutes
  - <<: *x-default-rule-settings-ukg-pro
    alert: "P1 : AI - LLM Passthrough : L3: High 5xx Error Rate - CRITICAL"
    expr: |
      (
        sum by (namespace, datacenter) (
          rate(http_request_count_total{
            namespace=~"ds-prod|ds-salesa|ds-salesb",
            name="service-large-language-model",
            http_status=~"5.."
          }[5m])
        )
        /
        sum by (namespace, datacenter) (
          rate(http_request_count_total{
            namespace=~"ds-prod|ds-salesa|ds-salesb",
            name="service-large-language-model"
          }[5m])
        )
      ) * 100 > 15
    for: 15m
    labels:
      <<: *x-default-labels
      severity: critical
      observability_layer: 3
      observability_layer_metric: application_error_rate
    annotations:
      SOPs: "TBD - Create SOP for LLM Passthrough high error rate"
      summary: "CRITICAL: LLM Passthrough 5xx error rate exceeds 15% threshold"
      description: "LLM Passthrough service in namespace: {{ $labels.namespace }}, datacenter: {{ $labels.datacenter }} has 5xx error rate of {{ $value | printf \"%.2f\" }}% which exceeds 15% threshold for the last 15 minutes."
      __dashboardUid__: llm-passthrough-unified-observability
      __panelId__: 401
      dashboard_url: 'https://ukg.grafana.net/d/llm-passthrough-unified-observability?orgId=1&from=now-12h&to=now&timezone=browser&var-datasource=fdfh4wr47u5tsb&var-namespace=ds-prod&var-dc=$__all'

  # WARNING ALERT: Response Time Degradation (P95 Latency)
  # Per technical requirements: P95 > 10 seconds for 15 minutes
  - <<: *x-default-rule-settings-ukg-pro
    alert: "P2 : AI - LLM Passthrough : L4: Response Time Degradation - P95 Latency High"
    expr: |
      histogram_quantile(0.95,
        sum by (le, namespace, datacenter) (
          rate(request_incoming_duration_seconds_bucket{
            namespace=~"ds-prod|ds-salesa|ds-salesb",
            name="service-large-language-model"
          }[5m])
        )
      ) > 10
    for: 15m
    labels:
      <<: *x-default-labels
      severity: warning
      observability_layer: 4
      observability_layer_metric: application_latency
    annotations:
      SOPs: "TBD - Create SOP for LLM Passthrough response time degradation"
      summary: "WARNING: LLM Passthrough P95 latency exceeds 10 second threshold"
      description: "LLM Passthrough service in namespace: {{ $labels.namespace }}, datacenter: {{ $labels.datacenter }} has P95 latency of {{ $value | printf \"%.2f\" }} seconds which exceeds 10 second threshold for the last 15 minutes."
      __dashboardUid__: llm-passthrough-unified-observability
      __panelId__: 402
      dashboard_url: 'https://ukg.grafana.net/d/llm-passthrough-unified-observability?orgId=1&from=now-12h&to=now&timezone=browser&var-datasource=fdfh4wr47u5tsb&var-namespace=ds-prod&var-dc=$__all'


grafanacloud_contactpoints:
  - name: llm_passthrough_prod_pagerduty
    route_type: pagerduty
    routing_key: "TBD"
    group_by: ['alertname', 'severity']
    send_resolve: True
