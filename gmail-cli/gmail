#!/bin/bash
#
# Gmail CLI Wrapper
# Common cleanup commands for gmail_cleanup.py
#

# Resolve symlinks to find the actual script location
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
PYTHON_SCRIPT="$SCRIPT_DIR/gmail_cleanup.py"

# Colors for output
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
NC=$'\033[0m' # No Color

usage() {
    cat << USAGE_EOF
${GREEN}Gmail CLI Wrapper${NC}

${YELLOW}Usage:${NC} gmail <command> [options]

${YELLOW}Commands:${NC}
  ${BLUE}promotions${NC} [age]      Clean promotional emails (default: 6m)
  ${BLUE}social${NC} [age]          Clean social notifications (default: 6m)
  ${BLUE}updates${NC} [age]         Clean update emails (default: 6m)
  ${BLUE}large${NC} [size] [age]    Find large emails (default: 5M, 1y)
  ${BLUE}from${NC} <sender>         Clean emails from specific sender
  ${BLUE}domain${NC} <domain>       Clean emails from entire domain
  ${BLUE}file${NC} <sender> <label> Label inbox emails from sender and archive
  ${BLUE}label${NC} <label> <query>  Label emails matching query and archive
  ${BLUE}tidy${NC}                  Run all filing rules from tidy-rules.json
  ${BLUE}download${NC} <query>      Download attachments from matching emails
  ${BLUE}labels${NC}                List all Gmail labels
  ${BLUE}get-label${NC} <label>     View messages under a label
  ${BLUE}unread${NC} [age]          Clean old unread emails (default: 1y)
  ${BLUE}search${NC} <query>        Run custom Gmail search query
  ${BLUE}help${NC}                  Show this help message

${YELLOW}Options:${NC}
  --trash, -t          Move to trash (default, recoverable)
  --delete, -d         Permanently delete
  --dry-run, -n        Preview only, don't delete
  --yes, -y            Skip confirmation prompt
  --max <num>          Maximum messages to process (default: 500)
  --output, -o <dir>   Output directory for downloads (default: ./gmail-downloads)

${YELLOW}Examples:${NC}
  gmail promotions                  # Trash promotions older than 6 months
  gmail promotions 1y               # Trash promotions older than 1 year
  gmail promotions --dry-run        # Preview only
  gmail large 10M 6m                # Find emails larger than 10M, older than 6 months
  gmail from newsletter@spam.com    # Clean emails from specific sender
  gmail domain @marketing.com       # Clean all emails from domain
  gmail file chase Chase            # Label Chase emails and archive from inbox
  gmail label Bills "from:utilities@example.com"   # Label matching emails and archive
  gmail label Receipts "subject:order confirmation" # Label by subject content
  gmail tidy                        # Run all filing rules to organize inbox
  gmail tidy --dry-run              # Preview what tidy would do
  gmail download "has:attachment newer_than:7d"          # Download recent attachments
  gmail download "from:boss@work.com" --output ~/files   # Download to specific dir
  gmail download "has:attachment" --dry-run               # Preview attachments
  gmail labels                          # List all Gmail labels
  gmail get-label promotions            # View messages under a label
  gmail get-label INBOX --max 5         # View 5 most recent inbox messages
USAGE_EOF
}

# Parse global options and extract them from args
parse_options() {
    ACTION="--trash"
    EXTRA_OPTS=()
    OUTPUT_DIR=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --trash|-t)
                ACTION="--trash"
                shift
                ;;
            --delete|-d)
                ACTION="--delete"
                shift
                ;;
            --dry-run|-n)
                ACTION="--dry-run"
                shift
                ;;
            --yes|-y)
                EXTRA_OPTS+=("--no-confirm")
                shift
                ;;
            --max)
                EXTRA_OPTS+=("--max" "$2")
                shift 2
                ;;
            --output|-o)
                OUTPUT_DIR="$2"
                shift 2
                ;;
            *)
                REMAINING_ARGS+=("$1")
                shift
                ;;
        esac
    done
}

run_query() {
    local query="$1"
    python3 "$PYTHON_SCRIPT" --query "$query" $ACTION "${EXTRA_OPTS[@]}"
}

run_label_query() {
    local query="$1"
    local label="$2"
    local dry_run_flag=""
    [[ "$ACTION" == "--dry-run" ]] && dry_run_flag="--dry-run"
    python3 "$PYTHON_SCRIPT" --query "$query" --label "$label" $dry_run_flag "${EXTRA_OPTS[@]}"
}

run_labels() {
    python3 "$PYTHON_SCRIPT" --labels
}

run_get_label() {
    local label="$1"
    local preview_flag=""
    # Check EXTRA_OPTS for --max; if present, use same value for --preview
    python3 "$PYTHON_SCRIPT" --get-label "$label" "${EXTRA_OPTS[@]}"
}

run_tidy() {
    local dry_run_flag=""
    [[ "$ACTION" == "--dry-run" ]] && dry_run_flag="--dry-run"
    python3 "$PYTHON_SCRIPT" --tidy $dry_run_flag "${EXTRA_OPTS[@]}"
}

run_download() {
    local query="$1"
    local output_dir="$2"
    local dry_run_flag=""
    [[ "$ACTION" == "--dry-run" ]] && dry_run_flag="--dry-run"
    local output_flag=""
    [[ -n "$output_dir" ]] && output_flag="--output $output_dir"
    python3 "$PYTHON_SCRIPT" --query "$query" --download $dry_run_flag $output_flag "${EXTRA_OPTS[@]}"
}

# Main command handling
if [[ $# -eq 0 ]]; then
    usage
    exit 0
fi

COMMAND="$1"
shift

REMAINING_ARGS=()
parse_options "$@"
set -- "${REMAINING_ARGS[@]}"

case "$COMMAND" in
    promotions)
        AGE="${1:-6m}"
        run_query "category:promotions older_than:$AGE"
        ;;
    social)
        AGE="${1:-6m}"
        run_query "category:social older_than:$AGE"
        ;;
    updates)
        AGE="${1:-6m}"
        run_query "category:updates older_than:$AGE"
        ;;
    large)
        SIZE="${1:-5M}"
        AGE="${2:-1y}"
        run_query "larger:$SIZE older_than:$AGE"
        ;;
    from)
        if [[ -z "$1" ]]; then
            echo -e "${RED}Error:${NC} 'from' command requires a sender email"
            echo "Usage: gmail from sender@example.com"
            exit 1
        fi
        run_query "from:$1"
        ;;
    domain)
        DOMAIN="$1"
        if [[ -z "$DOMAIN" ]]; then
            echo -e "${RED}Error:${NC} 'domain' command requires a domain"
            echo "Usage: gmail domain example.com"
            exit 1
        fi
        # Remove @ prefix if provided
        DOMAIN="${DOMAIN#@}"
        run_query "from:@$DOMAIN"
        ;;
    file)
        SENDER="$1"
        LABEL="$2"
        if [[ -z "$SENDER" ]] || [[ -z "$LABEL" ]]; then
            echo -e "${RED}Error:${NC} 'file' command requires sender and label"
            echo "Usage: gmail file <sender> <label>"
            echo "Example: gmail file chase Chase"
            exit 1
        fi
        run_label_query "in:inbox from:$SENDER" "$LABEL"
        ;;
    label)
        LABEL="$1"
        QUERY="$2"
        if [[ -z "$LABEL" ]] || [[ -z "$QUERY" ]]; then
            echo -e "${RED}Error:${NC} 'label' command requires a label name and a query"
            echo "Usage: gmail label <label> <query>"
            echo "Examples:"
            echo "  gmail label Bills \"from:utilities@example.com\""
            echo "  gmail label Receipts \"subject:order confirmation\""
            echo "  gmail label Work \"from:boss@company.com subject:project\""
            exit 1
        fi
        run_label_query "$QUERY" "$LABEL"
        ;;
    download)
        if [[ -z "$1" ]]; then
            echo -e "${RED}Error:${NC} 'download' command requires a search query"
            echo "Usage: gmail download <query> [--output <dir>]"
            echo "Examples:"
            echo "  gmail download \"has:attachment newer_than:7d\""
            echo "  gmail download \"from:someone@example.com\" --output ~/files"
            echo "  gmail download \"has:attachment\" --dry-run"
            exit 1
        fi
        run_download "$1" "$OUTPUT_DIR"
        ;;
    tidy)
        run_tidy
        ;;
    labels)
        run_labels
        ;;
    get-label)
        if [[ -z "$1" ]]; then
            echo -e "${RED}Error:${NC} 'get-label' command requires a label name"
            echo "Usage: gmail get-label <label>"
            echo "Examples:"
            echo "  gmail get-label promotions"
            echo "  gmail get-label INBOX --max 5"
            exit 1
        fi
        run_get_label "$1"
        ;;
    unread)
        AGE="${1:-1y}"
        run_query "is:unread older_than:$AGE"
        ;;
    search)
        if [[ -z "$1" ]]; then
            echo -e "${RED}Error:${NC} 'search' command requires a query"
            echo "Usage: gmail search \"your gmail query\""
            exit 1
        fi
        run_query "$1"
        ;;
    help|--help|-h)
        usage
        exit 0
        ;;
    *)
        echo -e "${RED}Error:${NC} Unknown command '$COMMAND'"
        echo "Run 'gmail help' for usage information."
        exit 1
        ;;
esac
